<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />

  <title>Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2</title>

  <meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1">



<link rel="apple-touch-icon" sizes="57x57" href="../assets/img/apple-touch-icon-57x57.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="60x60" href="../assets/img/apple-touch-icon-60x60.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="72x72" href="../assets/img/apple-touch-icon-72x72.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-touch-icon-76x76.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="114x114" href="../assets/img/apple-touch-icon-114x114.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="120x120" href="../assets/img/apple-touch-icon-120x120.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="144x144" href="../assets/img/apple-touch-icon-144x144.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="152x152" href="../assets/img/apple-touch-icon-152x152.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="180x180" href="../assets/img/apple-touch-icon-180x180.png?v=wAAv6Wqe6l">
<link rel="icon" type="image/png" href="../assets/img/favicon-32x32.png?v=wAAv6Wqe6l" sizes="32x32">
<link rel="icon" type="image/png" href="../assets/img/favicon-194x194.png?v=wAAv6Wqe6l" sizes="194x194">
<link rel="icon" type="image/png" href="../assets/img/favicon-96x96.png?v=wAAv6Wqe6l" sizes="96x96">
<link rel="icon" type="image/png" href="../assets/img/android-chrome-192x192.png?v=wAAv6Wqe6l" sizes="192x192">
<link rel="icon" type="image/png" href="../assets/img/favicon-16x16.png?v=wAAv6Wqe6l" sizes="16x16">
<link rel="manifest" href="../assets/img/manifest.json?v=wAAv6Wqe6l">
<link rel="shortcut icon" href="../assets/img/favicon.ico?v=wAAv6Wqe6l">
<meta name="msapplication-TileColor" content="#e74c3c">
<meta name="msapplication-TileImage" content="/assets/img/mstile-144x144.png?v=wAAv6Wqe6l">
<meta name="msapplication-config" content="/assets/img/browserconfig.xml?v=wAAv6Wqe6l">
<meta name="theme-color" content="#e74c3c">

  <link rel="stylesheet" type="text/css" href="../assets/css/uno.css?v=40fb1f9047" />

  <link rel="canonical" href="http://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/" />
    
    <meta property="og:site_name" content="CuongBN - Just Do It" />
    <meta property="og:type" content="article" />
    <meta property="og:title" content="Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2" />
    <meta property="og:description" content="This article is the second post in series: Introduce Protocol buffer and install protocol buffer compiler Wrire Producer and Consumer to work with protocol buffer and RabbitMQ In the previous article, we have installed Protocol buffer, define .proto file and..." />
    <meta property="og:url" content="http://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/" />
    <meta property="article:published_time" content="2015-08-26T14:42:09.000Z" />
    <meta property="article:modified_time" content="2015-08-26T14:42:09.000Z" />
    <meta property="article:tag" content="consumer" />
    <meta property="article:tag" content="git" />
    <meta property="article:tag" content="Linux" />
    <meta property="article:tag" content="producer" />
    <meta property="article:tag" content="protocol buffer" />
    <meta property="article:tag" content="rabbitmq" />
    
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:title" content="Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2" />
    <meta name="twitter:description" content="This article is the second post in series: Introduce Protocol buffer and install protocol buffer compiler Wrire Producer and Consumer to work with protocol buffer and RabbitMQ In the previous article, we have installed Protocol buffer, define .proto file and..." />
    <meta name="twitter:url" content="http://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/" />
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "CuongBN - Just Do It",
    "author": {
        "@type": "Person",
        "name": "Cuong Ba Ngoc",
        "image": "//www.gravatar.com/avatar/6d6e584a65d5852e400df206334e72b1?s=250&d=mm&r=x",
        "url": "http://cuongbangoc.github.io/author/cuongbangoc",
        "sameAs": null,
        "description": null
    },
    "headline": "Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2",
    "url": "http://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/",
    "datePublished": "2015-08-26T14:42:09.000Z",
    "dateModified": "2015-08-26T14:42:09.000Z",
    "keywords": "consumer, git, Linux, producer, protocol buffer, rabbitmq",
    "description": "This article is the second post in series: Introduce Protocol buffer and install protocol buffer compiler Wrire Producer and Consumer to work with protocol buffer and RabbitMQ In the previous article, we have installed Protocol buffer, define .proto file and..."
}
    </script>

    <meta name="generator" content="Ghost 0.6" />
    <link rel="alternate" type="application/rss+xml" title="CuongBN - Just Do It" href="http://cuongbangoc.github.io/rss/" />
    <script>
var profile_title = 'Cuong Ba Ngoc';
var profile_resume ='Software Engineer';
</script>

</head>
<body class="post-template tag-consumer tag-git-2 tag-linux tag-producer tag-protocol-buffer tag-rabbitmq">

  <section id="menu-button" class="expanded">
    <a><i class="icon icon-list"></i></a>
  </section>

  <aside class="cover">

  <div class="cover container">
    <div class="profile">
      <a id="avatar-link" title="link to homepage for CuongBN - Just Do It" href="http://cuongbangoc.github.io/#open">
        <img src="../content/images/2015/08/avatar.jpg" alt="CuongBN - Just Do It avatar" class="profile avatar rounded hvr-buzz-out" />
        <h1 id="profile-title">CuongBN - Just Do It</h1>
        <h3 id="profile-resume"></h3>
      </a>

      <hr class="divider long" />
      <p>Software Engineer, I&#x27;m a man passionate about programming languages, new technologies and open-sources...</p>
      <hr class="divider short" />
      <div class="navigation">
        <div class="profile contact">
          <nav class="navigation left">
  <ul class="links">
    <li class="links item">
      <a href="http://cuongbangoc.github.io/#open" class="link-item" title="CuongBN - Just Do It blog" id="blog-button">Blog</a>
        <a href="../index.html" class="link-item" id="-button">Home</a>
        <a href="../about/index.html" class="link-item" id="-button">About</a>
    </li>
  </ul>
</nav>
          
<nav class="navigation right">
  <ul class="social expanded">

  <!-- Twitter -->
  <!--<li class="social item hvr-grow-rotate">
    <a target="blank" href="http://twitter.com/kikobeats" title="@Kikobeats on Twitter">
      <i class='icon icon-social-twitter'></i>
      <span class="label">Twitter</span>
    </a>
  </li> -->

  <!-- Linkedin -->
  <li class="social item hvr-grow-rotate">
    <a target="blank" href="http://linkedin.com/in/cuongbangoc" title="CuongBaNgoc on LinkedIn">
      <i class='icon icon-social-linkedin'></i>
      <span class="label">Linkedin</span>
    </a>
  </li>

  <!-- Github -->
  <li class="social item hvr-grow-rotate">
    <a target="blank" href="https://github.com/cuongbangoc" title="CuongBaNgoc on Github">
      <i class='icon icon-social-github'></i>
      <span class="label">Github</span>
    </a>
  </li>

  <!-- Facebook -->
    <li class="social item hvr-grow-rotate">
      <a target="blank" href="http://facebook.com/ngoccuongkaka" title="CuongBaNgoc on Facebook">
        <i class='icon icon-social-facebook'></i>
        <span class="label">Facebook</span>
      </a>
    </li>

  <!-- RSS -->
  <li class="social item hvr-grow-rotate">
    <a href="../rss/index.html" title="Subscribe to RSS">
      <i class='icon icon-rss'></i>
      <span class="label">RSS</span>
    </a>
  </li>

  </ul>
</nav>
          <section class="icon icon-search" id="search-container">
  <hr class="divider short" />
  <form id="search-form">
    <input type="text", name="search", placeholder="git, css, javascript,..." id="search-field" />
  </form>
</section>
        </div>
      </div>
    </div>
  </div>
</aside>

  <main>
    <section id="search-results"></section>
    <section class="content">
      

  <article class="post tag-consumer tag-git-2 tag-linux tag-producer tag-protocol-buffer tag-rabbitmq">
    <header>
      <div class="post meta">
        <time datetime="26 Aug 2015">26 Aug 2015</time>
        <span class="post tags">in <a href="../tag/consumer/index.html">consumer</a> <a href="../tag/git-2/index.html">git</a> <a href="../tag/linux/index.html">Linux</a> <a href="../tag/producer/index.html">producer</a> <a href="../tag/protocol-buffer/index.html">protocol buffer</a> <a href="../tag/rabbitmq/index.html">rabbitmq</a></span>


        <span class="post reading-time"> ~ <span></span> read.</span>
      </div>

      <a alt="Tweet 'Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2'" href="https://twitter.com/intent/tweet?text=Protocol%20Buffers%20and%20RabbitMQ%20on%20Ubuntu%2014.04%20Part%202 %20%C2%BB%20&amp;url=http://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/" >
        
        <h1 class="icon-reverse icon-social-twitter-post" id="post-title">Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2</h1>
      </a>
    </header>

    <div id="post-content" class="post tag-consumer tag-git-2 tag-linux tag-producer tag-protocol-buffer tag-rabbitmq">
      <h5 id="thisarticleisthesecondpostinseries">This article is the second post in series:</h5>

<ul>
<li><a href="https://cuongba.wordpress.com/2015/08/26/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-1/">Introduce Protocol buffer and install protocol buffer compiler</a></li>
<li><a href="https://cuongba.wordpress.com/2015/08/26/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/">Wrire Producer and Consumer to work with protocol buffer and RabbitMQ</a></li>
</ul>

<p>In the previous article, we have installed Protocol buffer, define <strong>.proto</strong> file and use protocol buffer compiler to compile <strong>.protocol</strong> file. In this article, we will continue <strong>step 4</strong> and <strong>step 5</strong>, write producer and consumer in RabbitMQ to encode, decode and transfer protocol data. You can read about Step 1, step 2 and step 3 in the previous post.</p>

<p><strong>To use Protocol Buffers in my systems, I will:</strong></p>

<ul>
<li><strong>Step 1</strong>: Install Protocol buffer compiler on Ubuntu 14.04</li>
<li><strong>Step 2</strong>: Define message structure formats in a <code>.proto</code> file.</li>
<li><strong>Step 3</strong>: Use the protocol buffer compiler</li>
<li><strong>Step 4</strong>: Write Producer use the Python protocol buffer API to encode and send messages to RabbitMQ server</li>
<li><strong>Step 5</strong>: Write Consumer use the Python protocol buffer API to receive and decode messages from RabbitMQ server</li>
</ul>

<h3 id="spanclassshort_textidresult_boxlangenspanclasshpsstep4writeproducerusethepythonprotocolbufferapitoencodeandsendmessagestorabbitmqserverspanspan"><span class="short_text" id="result_box" lang="en"><span class="hps">Step 4: Write Producer use the Python protocol buffer API to encode and send messages to RabbitMQ server</span></span></h3>

<ul>
<li>At the first, we need to setup environment for this example. I will setup environment for Python 2.7 and use <strong>Pika</strong> library to work with RabbitMQ.</li>
</ul>

<p>You will need to know about <strong>virtualenv</strong> and use <strong>pip</strong>. Please read about it in the post : <a href="https://cuongba.wordpress.com/2015/04/21/set-up-virtual-environments-in-python-on-ubuntu-14-04/">Set Up Package Manager (PIP) And Virtual Environments in Python on Ubuntu 14.04</a>.</p>

<p>[sourcecode language=”bash” wraplines=”false” collapse=”false”] <br />
 virtualenv -p /usr/bin/python2.7 env <br />
 source env/bin/activate <br />
 pip install pika</p>

<p>[/sourcecode]</p>

<ul>
<li>Next, we need to install <strong>protocol_buffer<em>*</strong>library</em>* for Python to work with protocol buffer</li>
</ul>

<p>You can download protocol buffer code, Extract and copy <em>*python *</em>directory to your project <br />
   <br />
 [sourcecode language=”bash” wraplines=”false” collapse=”false”] <br />
 cd .. <br />
 git clone <a href="https://github.com/google/protobuf.git">https://github.com/google/protobuf.git</a> <br />
 cd protocol<em>buffers</em>python <br />
 cp ../protobuf/python . <br />
 cd python <br />
 python setup.py install <br />
 [/sourcecode] <br />
  </p>

<ul>
<li><p>Continue, I will have a <strong><em>config.py</em></strong> file, which store RabbitMQ server information.</p>

<p>  <br />
[sourcecode language=”bash” wraplines=”false” collapse=”false”] <br />
RABBIT<em>HOST= ‘localhost’ <br />
QUEUE</em>TOPIC = ‘topic_name’ <br />
[/sourcecode] <br />
 </p></li>
<li><p>Next, I will write <strong>*rabbit.py *</strong>to work with RabbitMQ.</p>

<p>  <br />
[sourcecode language=”python” wraplines=”false” collapse=”false”] <br />
import pika <br />
import config as cfg</p></li>
</ul>

<p>class Rabbit(): <br />
     def <strong>init</strong>(self): <br />
         self.conn = None <br />
         self.channel = None</p>

<p>    def connect(self): <br />
          self.conn = pika.BlockingConnection(pika.ConnectionParameters(host=cfg.RABBIT<em>HOST)) <br />
          self.channel = self.conn.channel() <br />
   <br />
     def close(self): <br />
         self.conn.close() <br />
   <br />
     def send(self, topic, data): <br />
         # Open connection <br />
         self.connect() <br />
         # Declare queue to send data <br />
         self.channel.queue</em>declare(topic) <br />
         # Send data <br />
         self.channel.basic<em>publish(exchange=”, routing</em>key=topic, body=data) <br />
         print(" [x] Sent data to RabbitMQ") <br />
   <br />
         # Close connection <br />
         self.close() <br />
   <br />
     def receive(self, topic, callback): <br />
         # Open connection <br />
         self.connect() <br />
         # Declare queue to send data <br />
         self.channel.queue<em>declare(topic) <br />
         print(‘ [*] Waiting for messages. To exit press CTRL+C’) <br />
   <br />
         # Listen and receive data from queue <br />
         self.channel.basic</em>consume(callback, queue=topic, no<em>ack=True) <br />
         self.channel.start</em>consuming()</p>

<p>[/sourcecode] <br />
  </p>

<ul>
<li><p>After that, we will start to write <strong><em>producer.py</em><em>*</em></strong>.<em>*</em></p>

<p>  <br />
[sourcecode language=”python” wraplines=”false” collapse=”false”] <br />
import users_pb2 <br />
import sys <br />
import config as cfg <br />
import rabbit</p></li>
</ul>

<p>r = rabbit.Rabbit() <br />
 list<em>users = users</em>pb2.ListUsers()</p>

<p>def input(user): <br />
     user.id = int(raw<em>input("Enter User ID: ")) <br />
     user.name = raw</em>input("Enter name: ") <br />
     email = raw<em>input("Enter email address (blank for none): ") <br />
     if email != ”: <br />
         user.email = email <br />
   <br />
 def send</em>rabbit(data): <br />
     # Connect to RabbitMQ and create channel <br />
     connection = pika.BlockingConnection(pika.ConnectionParameters(host=cfg.RABBIT<em>HOST)) <br />
     channel = connection.channel() <br />
     # Declare queue to send data <br />
     channel.queue</em>declare(queue=cfg.QUEUE<em>TOPIC) <br />
     Send data <br />
     channel.basic</em>publish(exchange=”, routing<em>key=cfg.QUEUE</em>TOPIC, body=data) <br />
     print(" [x] Sent data to RabbitMQ") <br />
     connection.close()</p>

<p>try: <br />
     # Add list users <br />
     input(list<em>users.user.add()) <br />
     # encode data <br />
     data</em>encode = list<em>users.SerializeToString() <br />
     # Send to rabbit <br />
     r.send(cfg.QUEUE</em>TOPIC, data_encode) <br />
   <br />
 except Exception as e: <br />
     print("Send data is error") <br />
     print(e)</p>

<p>[/sourcecode] <br />
  </p>

<h3 id="spanclassshort_textidresult_boxlangenspanclasshpsstep5writeconsumerusethepythonprotocolbufferapitoreceiveanddecodemessagesfromrabbitmqserverspanspan"><span class="short_text" id="result_box" lang="en"><span class="hps">Step 5: Write Consumer use the Python protocol buffer API to receive and decode messages from RabbitMQ server</span></span></h3>

<p>And the finally step, we will write a <strong>consumer <em>*to receive data and decode it. The content of *</strong>consumer.py:</em>**</p>

<p>  <br />
 [sourcecode language=”python” wraplines=”false” collapse=”false”] <br />
 import users_pb2 <br />
 import sys <br />
 import config as cfg</p>

<p>import rabbit</p>

<p>r = rabbit.Rabbit() <br />
 list<em>users = users</em>pb2.ListUsers()</p>

<p>def show(list<em>users): <br />
     for user in list</em>users.user: <br />
         print("User ID: {}".format(user.id)) <br />
         print("User Name: {}".format(user.name)) <br />
         if user.HasField(’email’): <br />
             print("Email: {}".format(user.email))</p>

<p>def callback_rabbit(ch, method, properties, body): <br />
     #print("Method: {}".format(method)) <br />
     #print("Properties: {}".format(properties))</p>

<p>    print("n=============================================<mark>=n") <br />
     list<em>users.ParseFromString(body) <br />
     show(list</em>users) <br />
     print("n</mark>==============================================n")</p>

<p>try: <br />
     # Receive Data from rabbit <br />
     r.receive(cfg.QUEUE<em>TOPIC, callback</em>rabbit) <br />
 except Exception as e: <br />
     print("receive data is error") <br />
     print(e)</p>

<p>[/sourcecode] <br />
  </p>

<h3 id="spanclassshort_textidresult_boxlangenspanclasshpstestproducerandconsumer"><span class="short_text" id="result_box" lang="en"><span class="hps">Test Producer and Consumer</h3>

<p></span></span></p>

<ul>
<li><p>The first, you run producer:</p>

<p>  <br />
[sourcecode language=”bash” wraplines=”false” collapse=”false”] <br />
(env)ngoccuong@ubuntu2:~/working/source<em>code/protocol</em>buffer_python$ python producer.py</p></li>
</ul>

<p>Enter User ID:</pre> <br />
 And enter your value</p>

<p>[/sourcecode] <br />
  </p>

<ul>
<li><p>After that, you run consumer, if you see as below, it is work properly :</p>

<p>  <br />
[code language=”bash” wraplines=”false” collapse=”false”] <br />
(env)ngoccuong@ubuntu2:~/working/source<em>code/protocol</em>buffer_python$ python consumer.py <br />
 [*] Waiting for messages. To exit press CTRL+C <br />
User ID: 2 <br />
User Name: cuong ba ngoc <br />
Email: cuongbangoc@gmail.com</pre></p></li>
</ul>

<p>[/code] <br />
   <br />
 So, we have completed install RabbitMQ as queue, send and receive <strong>Protocol Buffer</strong> data with it. Thank you for reading.</p>

<p>You can see full source code on:</p>

<p><a href="https://github.com/cuongbangoc/protocol_buffers_python">https://github.com/cuongbangoc/protocol<em>buffers</em>python</a></p>
    </div>

    <div class="post related">
        <a rel="prev" id="prev-btn" class="btn small square" href="../protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-1/index.html">← Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 1</a>

    </div>

    <footer class="post comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + window.disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</footer>

  </article>


      <footer>
  <span class="copyright">
   <a href="http://cuongbangoc.github.io" style="font-weight: bold;">CuongBa Blog</a> &copy; 2015. All rights reserved. Built with <a href="https://ghost.org/" target="_blank">Ghost</a> and <a href="https://github.com/Kikobeats/uno-zen" target="_blank">Uno Zen</a> theme.
  </span>
</footer>
    </section>
  </main>

  <script src="../public/jquery.js?v=40fb1f9047"></script>
  <script type="text/javascript" src="../assets/js/run_prettify.js?v=40fb1f9047"></script>
  <script type="text/javascript" src="../assets/js/uno.js?v=40fb1f9047"></script>
  <script>
  if (window.ga_id) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', window.ga_id, 'auto');
    ga('require', 'linkid', 'linkid.js');
    ga('send', 'pageview');
  }
</script>
</body>
</html>
