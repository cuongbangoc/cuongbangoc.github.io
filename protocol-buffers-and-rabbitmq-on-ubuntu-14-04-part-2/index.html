
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

  <title>Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2</title>

  <meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="viewport" content="width=device-width, initial-scale=1">



<link rel="apple-touch-icon" sizes="57x57" href="../assets/img/apple-touch-icon-57x57.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="60x60" href="../assets/img/apple-touch-icon-60x60.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="72x72" href="../assets/img/apple-touch-icon-72x72.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="76x76" href="../assets/img/apple-touch-icon-76x76.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="114x114" href="../assets/img/apple-touch-icon-114x114.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="120x120" href="../assets/img/apple-touch-icon-120x120.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="144x144" href="../assets/img/apple-touch-icon-144x144.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="152x152" href="../assets/img/apple-touch-icon-152x152.png?v=wAAv6Wqe6l">
<link rel="apple-touch-icon" sizes="180x180" href="../assets/img/apple-touch-icon-180x180.png?v=wAAv6Wqe6l">
<link rel="icon" type="image/png" href="../assets/img/favicon-32x32.png?v=wAAv6Wqe6l" sizes="32x32">
<link rel="icon" type="image/png" href="../assets/img/favicon-194x194.png?v=wAAv6Wqe6l" sizes="194x194">
<link rel="icon" type="image/png" href="../assets/img/favicon-96x96.png?v=wAAv6Wqe6l" sizes="96x96">
<link rel="icon" type="image/png" href="../assets/img/android-chrome-192x192.png?v=wAAv6Wqe6l" sizes="192x192">
<link rel="icon" type="image/png" href="../assets/img/favicon-16x16.png?v=wAAv6Wqe6l" sizes="16x16">
<link rel="manifest" href="../assets/img/manifest.json?v=wAAv6Wqe6l">
<link rel="shortcut icon" href="../assets/img/favicon.ico?v=wAAv6Wqe6l">
<meta name="msapplication-TileColor" content="#e74c3c">
<meta name="msapplication-TileImage" content="/assets/img/mstile-144x144.png?v=wAAv6Wqe6l">
<meta name="msapplication-config" content="/assets/img/browserconfig.xml?v=wAAv6Wqe6l">
<meta name="theme-color" content="#e74c3c">

  <link rel="stylesheet" type="text/css" href="../assets/css/uno.css?v=c42913231e">

  <link rel="canonical" href="http://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/">
    
    <meta property="og:site_name" content="CuongBN - Just Do It">
    <meta property="og:type" content="article">
    <meta property="og:title" content="Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2">
    <meta property="og:description" content="This article is the second post in series: Introduce Protocol buffer and install protocol buffer compiler Wrire Producer and Consumer to work with protocol buffer and RabbitMQ In the previous article, we have installed Protocol buffer, define .proto file and...">
    <meta property="og:url" content="http://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/">
    <meta property="article:published_time" content="2015-08-26T14:42:09.000Z">
    <meta property="article:modified_time" content="2015-08-30T14:32:56.877Z">
    <meta property="article:tag" content="consumer">
    <meta property="article:tag" content="git">
    <meta property="article:tag" content="Linux">
    <meta property="article:tag" content="producer">
    <meta property="article:tag" content="protocol buffer">
    <meta property="article:tag" content="rabbitmq">
    
    <meta name="twitter:card" content="summary">
    <meta name="twitter:title" content="Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2">
    <meta name="twitter:description" content="This article is the second post in series: Introduce Protocol buffer and install protocol buffer compiler Wrire Producer and Consumer to work with protocol buffer and RabbitMQ In the previous article, we have installed Protocol buffer, define .proto file and...">
    <meta name="twitter:url" content="http://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/">
    
    <script type="application/ld+json">
{
    "@context": "http://schema.org",
    "@type": "Article",
    "publisher": "CuongBN - Just Do It",
    "author": {
        "@type": "Person",
        "name": "Cuong Ba Ngoc",
        "image": "//www.gravatar.com/avatar/6d6e584a65d5852e400df206334e72b1?s=250&d=mm&r=x",
        "url": "http://cuongbangoc.github.io/author/cuongbangoc",
        "sameAs": null,
        "description": null
    },
    "headline": "Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2",
    "url": "http://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/",
    "datePublished": "2015-08-26T14:42:09.000Z",
    "dateModified": "2015-08-30T14:32:56.877Z",
    "keywords": "consumer, git, Linux, producer, protocol buffer, rabbitmq",
    "description": "This article is the second post in series: Introduce Protocol buffer and install protocol buffer compiler Wrire Producer and Consumer to work with protocol buffer and RabbitMQ In the previous article, we have installed Protocol buffer, define .proto file and..."
}
    </script>

    <meta name="generator" content="Ghost 0.6">
    <link rel="alternate" type="application/rss+xml" title="CuongBN - Just Do It" href="http://cuongbangoc.github.io/rss/">
    <script>
var profile_title = 'Cuong Ba Ngoc';
var profile_resume ='Software Engineer';
var disqus_shortname = 'cuongbaghost';
</script>

</head>
<body class="post-template tag-consumer tag-git-2 tag-linux tag-producer tag-protocol-buffer tag-rabbitmq">

  <section id="menu-button" class="expanded">
    <a href="index.html"><i class="icon icon-list"></i></a>
  </section>

  <aside class="cover">

  <div class="cover container">
    <div class="profile">
      <a id="avatar-link" title="link to homepage for CuongBN - Just Do It" href="../index.html#open">
        <img src="../content/images/2015/08/avatar.jpg" alt="CuongBN - Just Do It avatar" class="profile avatar rounded hvr-buzz-out">
        <h1 id="profile-title">CuongBN - Just Do It</h1>
        <h3 id="profile-resume"></h3>
      </a>

      <hr class="divider long">
      <p>Software Engineer, I'm a man passionate about programming languages, new technologies and open-sources...</p>
      <hr class="divider short">
      <div class="navigation">
        <div class="profile contact">
          <nav class="navigation left">
  <ul class="links">
    <li class="links item">
      <a href="../" class="link-item" title="Home" id="home-button"> Home </a>
      <a href="../index.html#open" class="link-item" title="CuongBN - Just Do It blog" id="blog-button">Blog</a>
        <a href="../about/" class="link-item" id="-button">About</a>
    </li>
  </ul>
</nav>
          
<nav class="navigation right">
  <ul class="social expanded">

  <!-- Twitter -->
  <!--<li class="social item hvr-grow-rotate">
    <a target="blank" href="http://twitter.com/kikobeats" title="@Kikobeats on Twitter">
      <i class='icon icon-social-twitter'></i>
      <span class="label">Twitter</span>
    </a>
  </li> -->

  <!-- Linkedin -->
  <li class="social item hvr-grow-rotate">
    <a target="blank" href="http://linkedin.com/in/cuongbangoc" title="CuongBaNgoc on LinkedIn">
      <i class="icon icon-social-linkedin"></i>
      <span class="label">Linkedin</span>
    </a>
  </li>

  <!-- Github -->
  <li class="social item hvr-grow-rotate">
    <a target="blank" href="https://github.com/cuongbangoc" title="CuongBaNgoc on Github">
      <i class="icon icon-social-github"></i>
      <span class="label">Github</span>
    </a>
  </li>

  <!-- Facebook -->
    <li class="social item hvr-grow-rotate">
      <a target="blank" href="http://facebook.com/ngoccuongkaka" title="CuongBaNgoc on Facebook">
        <i class="icon icon-social-facebook"></i>
        <span class="label">Facebook</span>
      </a>
    </li>

  <!-- RSS -->
  <li class="social item hvr-grow-rotate">
    <a href="../rss/index.rss" title="Subscribe to RSS">
      <i class="icon icon-rss"></i>
      <span class="label">RSS</span>
    </a>
  </li>

  </ul>
</nav>
          <section class="icon icon-search" id="search-container">
  <hr class="divider short">
  <form id="search-form">
    <input type="text" name="search" placeholder="git, css, javascript,..." id="search-field">
  </form>
</section>
        </div>
      </div>
    </div>
  </div>
</aside>

  <main>
    <section id="search-results"></section>
    <section class="content">
      

  <article class="post tag-consumer tag-git-2 tag-linux tag-producer tag-protocol-buffer tag-rabbitmq">
    <header>
      <div class="post meta">
        <time datetime="26 Aug 2015">26 Aug 2015</time>
        <span class="post tags">in <a href="../tag/consumer/">consumer</a> <a href="../tag/git-2/">git</a> <a href="../tag/linux/">Linux</a> <a href="../tag/producer/">producer</a> <a href="../tag/protocol-buffer/">protocol buffer</a> <a href="../tag/rabbitmq/">rabbitmq</a></span>


        <span class="post reading-time"> ~ <span></span> read.</span>
      </div>

      <a alt="Tweet 'Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2'" href="https://twitter.com/intent/tweet?text=Protocol%20Buffers%20and%20RabbitMQ%20on%20Ubuntu%2014.04%20Part%202%20%20%C2%BB%20&amp;url=http://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/">
        
        <h1 class="icon-reverse icon-social-twitter-post" id="post-title">Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 2</h1>
      </a>
    </header>

    <div id="post-content" class="post tag-consumer tag-git-2 tag-linux tag-producer tag-protocol-buffer tag-rabbitmq">
      <h5 id="thisarticleisthesecondpostinseries">This article is the second post in series:</h5>

<ul>
<li><a href="https://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-1/">Introduce Protocol buffer and install protocol buffer compiler</a></li>
<li><a href="https://cuongbangoc.github.io/protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-2/">Wrire Producer and Consumer to work with protocol buffer and RabbitMQ</a></li>
</ul>

<p>In the previous article, we have installed Protocol buffer, define <strong>.proto</strong> file and use protocol buffer compiler to compile <strong>.protocol</strong> file. In this article, we will continue <strong>step 4</strong> and <strong>step 5</strong>, write producer and consumer in RabbitMQ to encode, decode and transfer protocol data. You can read about Step 1, step 2 and step 3 in the previous post.</p>

<p><strong>To use Protocol Buffers in my systems, I will:</strong></p>

<ul>
<li><strong>Step 1</strong>: Install Protocol buffer compiler on Ubuntu 14.04</li>
<li><strong>Step 2</strong>: Define message structure formats in a <code>.proto</code> file.</li>
<li><strong>Step 3</strong>: Use the protocol buffer compiler</li>
<li><strong>Step 4</strong>: Write Producer use the Python protocol buffer API to encode and send messages to RabbitMQ server</li>
<li><strong>Step 5</strong>: Write Consumer use the Python protocol buffer API to receive and decode messages from RabbitMQ server</li>
</ul>

<h3 id="step4writeproducerusethepythonprotocolbufferapitoencodeandsendmessagestorabbitmqserver">Step 4: Write Producer use the Python protocol buffer API to encode and send messages to RabbitMQ server</h3>

<ul>
<li>At the first, we need to setup environment for this example. I will setup environment for Python 2.7 and use <strong>Pika</strong> library to work with RabbitMQ.</li>
</ul>

<p>You will need to know about <strong>virtualenv</strong> and use <strong>pip</strong>. Please read about it in the post : <a href="https://cuongbangoc.github.io/set-up-virtual-environments-in-python-on-ubuntu-14-04/">Set Up Package Manager (PIP) And Virtual Environments in Python on Ubuntu 14.04</a>.</p>

<pre><code class="language-prettyprint lang-bash  ">virtualenv -p /usr/bin/python2.7 env  
source env/bin/activate  
pip install pika  
</code></pre>

<ul>
<li>Next, we need to install <strong>protocol_buffer library</strong> for Python to work with protocol buffer</li>
</ul>

<p>You can download protocol buffer code, Extract and copy <strong>python</strong> directory to your project  </p>

<pre><code class="language-prettyprint lang-bash  ">cd ..  
git clone https://github.com/google/protobuf.git  
cd protocol_buffers_python  
cp ../protobuf/python .  
cd python  
python setup.py install  
</code></pre>

<ul>
<li>Continue, I will have a <strong><em>config.py</em></strong> file, which store RabbitMQ server information.</li>
</ul>

<pre><code class="language-prettyprint lang-python  ">RABBIT_HOST= ‘localhost’  
QUEUE_TOPIC = ‘topic_name’  
</code></pre>

<ul>
<li>Next, I will write <strong>*rabbit.py *</strong>to work with RabbitMQ.</li>
</ul>

<pre><code class="language-prettyprint lang-bash  ">import pika  
import config as cfg

class Rabbit():  
     def __init__(self):  
         self.conn = None  
         self.channel = None

     def connect(self):  
         self.conn = pika.BlockingConnection(pika.ConnectionParameters(host=cfg.RABBIT_HOST))  
         self.channel = self.conn.channel()  
    
     def close(self):  
         self.conn.close()  
    
     def send(self, topic, data):  
         # Open connection  
         self.connect()  
         # Declare queue to send data  
         self.channel.queue_declare(topic)  
         # Send data  
         self.channel.basic_publish(exchange=”, routing_key=topic, body=data)  
         print(" [x] Sent data to RabbitMQ")  
    
         # Close connection  
         self.close()  
    
     def receive(self, topic, callback):  
         # Open connection  
         self.connect()  
         # Declare queue to send data  
         self.channel.queue_declare(topic)  
         print(‘ [*] Waiting for messages. To exit press CTRL+C’)  
    
         # Listen and receive data from queue  
         self.channel.basic_consume(callback, queue=topic, no_ack=True)  
         self.channel.start_consuming()
</code></pre>

<ul>
<li>After that, we will start to write <strong><em>producer.py</em><em>*</em></strong>.<em>*</em>
   </li>
</ul>

<pre><code class="language-prettyprint lang-python  ">import users_pb2  
import sys  
import config as cfg  
import rabbit

r = rabbit.Rabbit()  
list_users = users_pb2.ListUsers()

def input(user):  
    user.id = int(raw_input("Enter User ID: "))  
    user.name = raw_input("Enter name: ")  
    email = raw_input("Enter email address (blank for none): ")  
    if email != ”:  
        user.email = email  
    
def send_rabbit(data):  
    # Connect to RabbitMQ and create channel  
    connection = pika.BlockingConnection(pika.ConnectionParameters(host=cfg.RABBIT_HOST))
    channel = connection.channel()  
    # Declare queue to send data  
    channel.queue_declare(queue=cfg.QUEUE_TOPIC)  
    # Send data  
    channel.basic_publish(exchange=”, routing_key=cfg.QUEUE_TOPIC, body=data)  
    print(" [x] Sent data to RabbitMQ")  
    connection.close()

try:  
    # Add list users  
    input(list_users.user.add())  
    # encode data  
    data_encode = list_users.SerializeToString()  
    # Send to rabbit  
    r.send(cfg.QUEUE_TOPIC, data_encode)  
    
except Exception as e:  
    print("Send data is error")  
    print(e)
</code></pre>

<h3 id="step5writeconsumerusethepythonprotocolbufferapitoreceiveanddecodemessagesfromrabbitmqserver">Step 5: Write Consumer use the Python protocol buffer API to receive and decode messages from RabbitMQ server</h3>

<p>And the finally step, we will write a <strong>consumer</strong> to receive data and decode it. The content of <strong><em>consumer.py:</em></strong></p>

<pre><code class="language-prettyprint lang-python  ">import users_pb2  
import sys  
import config as cfg

import rabbit

r = rabbit.Rabbit()  
list_users = users_pb2.ListUsers()

def show(list_users):  
    for user in list_users.user:  
        print("User ID: {}".format(user.id))  
        print("User Name: {}".format(user.name))  
        if user.HasField(’email’):  
            print("Email: {}".format(user.email))

def callback_rabbit(ch, method, properties, body):  
    #print("Method: {}".format(method))  
    #print("Properties: {}".format(properties))

    print("n================================================n")  
    list_users.ParseFromString(body)  
    show(list_users)  

    print("n================================================n")

try:  
    # Receive Data from rabbit  
    r.receive(cfg.QUEUE_TOPIC, callback_rabbit)  
except Exception as e:  
    print("receive data is error")  
    print(e)
</code></pre>

<h3 id="testproducerandconsumer">Test Producer and Consumer</h3>

<ul>
<li>The first, you run producer:</li>
</ul>

<pre><code class="language-prettyprint lang-bash  ">(env)ngoccuong@ubuntu2:~/working/source_code/protocol_buffer_python$ python producer.py

Enter User ID:  
</code></pre>

<p>And enter your value  </p>

<ul>
<li>After that, you run consumer, if you see as below, it is work properly :</li>
</ul>

<pre><code class="language-prettyprint lang-bash  ">(env)ngoccuong@ubuntu2:~/working/source_code/protocol_buffer_python$ python consumer.py  

[*] Waiting for messages. To exit press CTRL+C  
User ID: 2  
User Name: cuong ba ngoc  
Email: cuongbangoc@gmail.com  
</code></pre>

<p>  <br>
So, we have completed install RabbitMQ as queue, send and receive <strong>Protocol Buffer</strong> data with it. Thank you for reading.</p>

<p>You can see full source code on:</p>

<p><a href="https://github.com/cuongbangoc/protocol_buffers_python">https://github.com/cuongbangoc/protocol<em>buffers</em>python</a></p>
    </div>

    <div class="post related">
        <a rel="prev" id="prev-btn" class="btn small square" href="../protocol-buffers-and-rabbitmq-on-ubuntu-14-04-part-1/">← Protocol Buffers and RabbitMQ on Ubuntu 14.04 Part 1</a>

    </div>

    <footer class="post comments">
  <div id="disqus_thread"></div>
  <script type="text/javascript">
  (function() {
  var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
  dsq.src = '//' + window.disqus_shortname + '.disqus.com/embed.js';
  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
  </script>
  <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
  <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
</footer>

  </article>


      <footer>
  <span class="copyright">
   <a href="http://cuongbangoc.github.io" style="font-weight: bold;">CuongBa Blog</a> © 2015. All rights reserved. Built with <a href="https://ghost.org/" target="_blank">Ghost</a> and <a href="https://github.com/Kikobeats/uno-zen" target="_blank">Uno Zen</a> theme.
  </span>
</footer>
    </section>
  </main>

  <script src="../public/jquery.js?v=c42913231e"></script>
  <script type="text/javascript" src="../assets/js/run_prettify.js?v=c42913231e"></script>
  <script type="text/javascript" src="../assets/js/uno.js?v=c42913231e"></script>
  <script>
  if (window.ga_id) {
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
    (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
    m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
    ga('create', window.ga_id, 'auto');
    ga('require', 'linkid', 'linkid.js');
    ga('send', 'pageview');
  }
</script>
</body>
